<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®¡ç†æ§åˆ¶å° - Weitao Jiang</title>
  <link rel="stylesheet" href="blog.css">
  <style>
    /* ä¿ç•™ç®¡ç†å°è‡ªå®šä¹‰æ ·å¼å’ŒåŠ¨ç”» */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }
    .stat-card {
      background: rgba(44,44,44,0.97);
      border-radius: 15px;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-5px);
    }
    .stat-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    .stat-label {
      color: var(--white);
      font-size: 1.1rem;
    }
    .admin-section {
      background: rgba(44,44,44,0.97);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    .section-title {
      font-size: 1.5rem;
      color: var(--primary-color);
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 0.5rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--white);
    }
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--white);
    }
    /* ç”¨æˆ·ç®¡ç†æ ·å¼ */
    .blog-btn-info {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s ease;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .blog-btn-info:hover {
      background: #138496;
      transform: translateY(-1px);
    }
    /* åŠ¨ç”» */
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>
</head>
<body>
  <header class="blog-header">
    <nav class="blog-nav">
      <a href="../index.html" class="blog-logo">Weitao Jiang</a>
      <button class="blog-menu-toggle" aria-label="èœå•">&#9776;</button>
      <ul class="blog-nav-links">
        <li><a href="../index.html">é¦–é¡µ</a></li>
        <li><a href="index.html">åšå®¢</a></li>
        <li><a href="../docs-html/index.html">ç¬”è®°</a></li>
        <li><a href="../about-the-author.html">å…³äº</a></li>
        <li><a href="#" class="active">ç®¡ç†</a></li>
        <li><a href="comment-admin.html" id="commentAdminLink" style="display: none;">è¯„è®ºç®¡ç†</a></li>
        <li><a href="image-admin.html" id="imageAdminLink" style="display: none;">å›¾ç‰‡ç®¡ç†</a></li>
      </ul>
      <div id="authSection" class="auth-buttons">
        <div id="userInfo" class="user-info">
          <span class="username" id="usernameSpan">ğŸ‘‹ ç®¡ç†å‘˜</span>
          <button class="logout-btn" onclick="handleLogout()">é€€å‡º</button>
        </div>
      </div>
    </nav>
  </header>

  <div class="blog-container">
    <h1 class="page-title">ğŸ“Š ç®¡ç†æ§åˆ¶å°</h1>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“</div>
        <div class="stat-number" id="totalPosts">-</div>
        <div class="stat-label">æ€»æ–‡ç« æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ’¬</div>
        <div class="stat-number" id="totalComments">-</div>
        <div class="stat-label">æ€»è¯„è®ºæ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">B</div>
        <div class="stat-number" id="totalImageSize">--</div>
        <div class="stat-label">æ€»æ–‡ä»¶å¤§å°</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘ï¸</div>
        <div class="stat-number" id="totalViews">-</div>
        <div class="stat-label">æ€»è®¿é—®é‡</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-number" id="totalUsers">-</div>
        <div class="stat-label">ç”¨æˆ·æ•°é‡</div>
      </div>
    </div>

    <div class="admin-section">
      <h2 class="section-title">ğŸ“š æ–‡ç« ç®¡ç†</h2>
      <div id="postManagement" class="post-list">
        <div class="loading">æ­£åœ¨åŠ è½½æ–‡ç« ...</div>
      </div>
    </div>

    <div class="admin-section">
      <h2 class="section-title">ï¿½ è¯„è®ºç®¡ç†</h2>
      <div id="commentManagement" class="post-list">
        <div class="loading">æ­£åœ¨åŠ è½½è¯„è®º...</div>
      </div>
    </div>

    <div class="admin-section">
      <h2 class="section-title">ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†</h2>
      <div id="imageManagement" class="post-list">
        <div class="loading">æ­£åœ¨åŠ è½½å›¾ç‰‡...</div>
      </div>
    </div>

    <div class="admin-section">
      <h2 class="section-title">ï¿½ ä¿®æ”¹å¯†ç </h2>
      <form id="changePwdForm" style="max-width:400px; margin:0 auto;">
        <div class="blog-form-group">
          <label class="blog-form-label" for="oldPwd">å½“å‰å¯†ç </label>
          <input type="password" id="oldPwd" class="blog-form-input" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " required>
        </div>
        <div class="blog-form-group">
          <label class="blog-form-label" for="newPwd">æ–°å¯†ç </label>
          <input type="password" id="newPwd" class="blog-form-input" placeholder="è¯·è¾“å…¥æ–°å¯†ç " required>
        </div>
        <div class="blog-form-group">
          <label class="blog-form-label" for="confirmPwd">ç¡®è®¤æ–°å¯†ç </label>
          <input type="password" id="confirmPwd" class="blog-form-input" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
        </div>
        <button type="submit" class="blog-btn blog-btn-primary" style="width:100%;margin-top:1.2rem;">ä¿®æ”¹å¯†ç </button>
      </form>
    </div>
    <div class="admin-section">
      <h2 class="section-title">ï¿½ï¿½ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
      <div id="userManagement" class="post-list">
        <div class="loading">æ­£åœ¨åŠ è½½ç”¨æˆ·...</div>
      </div>
    </div>
  </div>

  <script src="jwt-auth.js"></script>
  <script src="blog-manager.js"></script>
  <script>
    // æ±‰å ¡èœå•å±•å¼€/æ”¶èµ·+è‡ªé€‚åº”
    document.addEventListener('DOMContentLoaded', function() {
      var toggle = document.querySelector('.blog-menu-toggle');
      var navLinks = document.querySelector('.blog-nav-links');
      function handleResize() {
        if (window.innerWidth > 768 && navLinks) {
          navLinks.classList.remove('open');
        }
      }
      if (toggle && navLinks) {
        toggle.addEventListener('click', function() {
          navLinks.classList.toggle('open');
        });
        window.addEventListener('resize', handleResize);
        handleResize(); // åˆå§‹æ‰§è¡Œä¸€æ¬¡
      }
    });
  </script>
  <script>
    // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
    function checkAdminAccess() {
      if (!window.authManager || !window.authManager.isLoggedIn()) {
        alert('è¯·å…ˆç™»å½•');
        location.href = 'index.html';
        return false;
      }
      
      if (!window.authManager.isAdmin()) {
        alert('éœ€è¦ç®¡ç†å‘˜æƒé™');
        location.href = 'index.html';
        return false;
      }
      
      return true;
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const posts = await blogManager.getAllPosts();
        const comments = await blogManager.getAllComments();
        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        const totalPosts = posts.length;
        const totalComments = comments.length;
        const totalViews = posts.reduce((sum, post) => sum + (post.views || 0), 0);

        // è·å–å›¾ç‰‡æ€»å¤§å°
        let totalImageSize = '--';
        try {
          const headers = window.authManager ? window.authManager.getAuthHeaders() : {};
          const res = await fetch('/api/images', { headers, credentials: 'include' });
          if (res.ok) {
            const files = await res.json();
            if (Array.isArray(files) && files.length > 0) {
              const total = files.reduce((sum, f) => sum + (f.size || 0), 0);
              totalImageSize = formatSize(total);
            } else {
              totalImageSize = '0 B';
            }
          }
        } catch {}

        // è·å–ç”¨æˆ·æ€»æ•°
        let totalUsers = '-';
        try {
          const headers = window.authManager ? window.authManager.getAuthHeaders() : {};
          const res = await fetch('/api/users', { headers, credentials: 'include' });
          if (res.ok) {
            const result = await res.json();
            totalUsers = result.users ? result.users.length : 0;
          }
        } catch {}

        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('totalPosts').textContent = totalPosts;
        document.getElementById('totalComments').textContent = totalComments;
        document.getElementById('totalViews').textContent = totalViews;
        document.getElementById('totalImageSize').textContent = totalImageSize;
        document.getElementById('totalUsers').textContent = totalUsers;
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
      }
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatSize(size) {
      if (!size || isNaN(size)) return '--';
      if (size < 1024) return size + ' B';
      if (size < 1024 * 1024) return (size / 1024).toFixed(1) + ' KB';
      if (size < 1024 * 1024 * 1024) return (size / 1024 / 1024).toFixed(2) + ' MB';
      return (size / 1024 / 1024 / 1024).toFixed(2) + ' GB';
    }

    // åŠ è½½æ–‡ç« ç®¡ç†åˆ—è¡¨
    async function loadPostManagement() {
      const container = document.getElementById('postManagement');
      
      try {
        const posts = await blogManager.getAllPosts();
        
        if (posts.length === 0) {
          container.innerHTML = '<div class="empty-state"><i>ğŸ“</i><p>æš‚æ— æ–‡ç« </p></div>';
          return;
        }

        container.innerHTML = '';
        
        // æŒ‰æ—¥æœŸæ’åºï¼Œæœ€æ–°çš„åœ¨å‰
        posts.sort((a, b) => {
          if (a.date && b.date) {
            const dateA = new Date(a.date);
            const dateB = new Date(b.date);
            if (dateA.getTime() !== dateB.getTime()) {
              return dateB.getTime() - dateA.getTime();
            }
          }
          return (b.id || 0) - (a.id || 0);
        });

        posts.forEach(post => {
          const postElement = document.createElement('div');
          postElement.className = 'blog-card';
          postElement.innerHTML = `
            <div class="blog-content" style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1.5rem;">
              <div style="flex:1; min-width:200px;">
                <div class="blog-title" style="margin-bottom:0.5rem;">${post.title}</div>
                <div class="blog-meta">
                  <span class="blog-category">${post.category}</span>
                  <span class="blog-date">${post.date}</span>
                  <span class="blog-views">ğŸ‘ï¸ ${post.views || 0}</span>
                </div>
              </div>
              <div class="post-actions" style="display:flex; gap:0.5rem; align-items:center;">
                <a href="post.html?id=${post.id}" class="blog-btn blog-btn-primary" style="color:#fff;">æŸ¥çœ‹</a>
                <a href="write-post.html?edit=${post.id}" class="blog-btn blog-btn-secondary">ç¼–è¾‘</a>
                <button class="blog-btn blog-btn-danger" onclick="deletePost(${post.id})">åˆ é™¤</button>
              </div>
            </div>
          `;
          container.appendChild(postElement);
        });
      } catch (error) {
        console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
        container.innerHTML = '<div class="empty-state"><i>âŒ</i><p>åŠ è½½å¤±è´¥</p></div>';
      }
    }

    // åŠ è½½ç”¨æˆ·ç®¡ç†åˆ—è¡¨
    async function loadUserManagement() {
      const container = document.getElementById('userManagement');
      
      try {
        // ä»æœåŠ¡å™¨è·å–ç”¨æˆ·æ•°æ®
        const headers = window.authManager ? window.authManager.getAuthHeaders() : {};
        const response = await fetch('/api/users', { 
          headers, 
          credentials: 'include' 
        });
        
        if (!response.ok) {
          throw new Error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
        }
        
        const result = await response.json();
        const users = result.users || [];

        if (users.length === 0) {
          container.innerHTML = '<div class="empty-state"><i>ğŸ‘¥</i><p>æš‚æ— ç”¨æˆ·</p></div>';
          return;
        }

        container.innerHTML = '';
        
        users.forEach(user => {
          const userElement = document.createElement('div');
          userElement.className = 'blog-card';
          userElement.innerHTML = `
            <div class="blog-content" style="display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:1.5rem;">
              <div style="flex:1; min-width:200px;">
                <div class="blog-title" style="margin-bottom:0.5rem;">${user.username}</div>
                <div class="blog-meta">
                  <span class="blog-category">${user.role}</span>
                  <span class="blog-date">${user.email || 'æœªè®¾ç½®é‚®ç®±'}</span>
                  <span class="blog-views">æœ€åç™»å½•: ${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'ä»æœªç™»å½•'}</span>
                </div>
                <div class="blog-excerpt" style="margin-top:0.5rem;">
                  åˆ›å»ºæ—¶é—´: ${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'æœªçŸ¥'}
                  ${user.isActive ? '' : ' â€¢ <span style="color:#dc3545;">å·²ç¦ç”¨</span>'}
                </div>
              </div>
              <div class="post-actions" style="display:flex; gap:0.5rem; align-items:center;">
                <button class="blog-btn blog-btn-secondary" onclick="editUser(${user.id})">ç¼–è¾‘</button>
                <button class="blog-btn blog-btn-info" onclick="resetUserPassword(${user.id})">é‡ç½®å¯†ç </button>
                ${user.role !== 'admin' ? `<button class="blog-btn blog-btn-danger" onclick="deleteUser(${user.id})">åˆ é™¤</button>` : ''}
              </div>
            </div>
          `;
          container.appendChild(userElement);
        });
        
        // æ·»åŠ åˆ›å»ºç”¨æˆ·æŒ‰é’®
        const addUserButton = document.createElement('div');
        addUserButton.className = 'blog-card';
        addUserButton.style.cssText = 'border: 2px dashed var(--primary-color); cursor: pointer; transition: all 0.3s ease;';
        addUserButton.innerHTML = `
          <div class="blog-content" style="text-align: center; padding: 2rem;">
            <div style="color: var(--primary-color); font-size: 3rem; margin-bottom: 1rem;">â•</div>
            <div style="color: var(--primary-color); font-size: 1.2rem; font-weight: bold;">æ·»åŠ æ–°ç”¨æˆ·</div>
          </div>
        `;
        addUserButton.addEventListener('click', showAddUserDialog);
        addUserButton.addEventListener('mouseenter', () => {
          addUserButton.style.transform = 'translateY(-3px)';
          addUserButton.style.boxShadow = '0 15px 35px rgba(0, 0, 0, 0.3)';
        });
        addUserButton.addEventListener('mouseleave', () => {
          addUserButton.style.transform = 'translateY(0)';
          addUserButton.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.2)';
        });
        container.appendChild(addUserButton);

      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
        container.innerHTML = '<div class="empty-state"><i>âŒ</i><p>åŠ è½½å¤±è´¥: ' + error.message + '</p></div>';
      }
    }

    // åˆ é™¤æ–‡ç« 
    async function deletePost(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }

      try {
        await blogManager.deletePost(id);
        showMessage('æ–‡ç« åˆ é™¤æˆåŠŸ', 'success');
        await loadPostManagement();
        await loadStats();
      } catch (error) {
        console.error('åˆ é™¤æ–‡ç« å¤±è´¥:', error);
        showMessage('åˆ é™¤æ–‡ç« å¤±è´¥: ' + error.message, 'error');
      }
    }

    // ç¼–è¾‘ç”¨æˆ·
    function editUser(id) {
      showMessage('ç”¨æˆ·ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // é‡ç½®ç”¨æˆ·å¯†ç 
    async function resetUserPassword(id) {
      if (!confirm('ç¡®å®šè¦é‡ç½®è¯¥ç”¨æˆ·çš„å¯†ç å—ï¼Ÿæ–°å¯†ç å°†è®¾ç½®ä¸ºé»˜è®¤å¯†ç ã€‚')) {
        return;
      }
      showMessage('å¯†ç é‡ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // åˆ é™¤ç”¨æˆ·
    async function deleteUser(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }
      showMessage('ç”¨æˆ·åˆ é™¤åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // æ˜¾ç¤ºæ·»åŠ ç”¨æˆ·å¯¹è¯æ¡†
    function showAddUserDialog() {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;

      const dialog = document.createElement('div');
      dialog.style.cssText = `
        background: var(--dark-bg);
        color: var(--white);
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        width: 400px;
        max-width: 90vw;
        border: 1px solid var(--primary-color);
      `;

      dialog.innerHTML = `
        <h3 style="margin-top: 0; text-align: center; color: var(--primary-color);">æ·»åŠ æ–°ç”¨æˆ·</h3>
        <form id="addUserForm">
          <div class="blog-form-group">
            <label class="blog-form-label" for="newUsername">ç”¨æˆ·å:</label>
            <input type="text" id="newUsername" class="blog-form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
          </div>
          <div class="blog-form-group">
            <label class="blog-form-label" for="newUserEmail">é‚®ç®±:</label>
            <input type="email" id="newUserEmail" class="blog-form-input" placeholder="è¯·è¾“å…¥é‚®ç®± (å¯é€‰)">
          </div>
          <div class="blog-form-group">
            <label class="blog-form-label" for="newUserPassword">å¯†ç :</label>
            <input type="password" id="newUserPassword" class="blog-form-input" placeholder="è¯·è¾“å…¥å¯†ç " required>
          </div>
          <div class="blog-form-group">
            <label class="blog-form-label" for="newUserRole">è§’è‰²:</label>
            <select id="newUserRole" class="blog-form-input" required>
              <option value="user">æ™®é€šç”¨æˆ·</option>
              <option value="editor">ç¼–è¾‘</option>
              <option value="admin">ç®¡ç†å‘˜</option>
            </select>
          </div>
          <div id="addUserErrorMsg" style="color: #dc3545; margin-bottom: 1rem; display: none;"></div>
          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="blog-btn blog-btn-primary" style="flex: 1;">åˆ›å»ºç”¨æˆ·</button>
            <button type="button" id="cancelAddUser" class="blog-btn blog-btn-secondary" style="flex: 1;">å–æ¶ˆ</button>
          </div>
        </form>
      `;

      overlay.appendChild(dialog);
      document.body.appendChild(overlay);

      const form = dialog.querySelector('#addUserForm');
      const errorMsg = dialog.querySelector('#addUserErrorMsg');
      const cancelBtn = dialog.querySelector('#cancelAddUser');

      const cleanup = () => {
        document.body.removeChild(overlay);
      };

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = dialog.querySelector('#newUsername').value.trim();
        const email = dialog.querySelector('#newUserEmail').value.trim();
        const password = dialog.querySelector('#newUserPassword').value;
        const role = dialog.querySelector('#newUserRole').value;

        if (!username || !password) {
          errorMsg.textContent = 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º';
          errorMsg.style.display = 'block';
          return;
        }

        if (password.length < 6) {
          errorMsg.textContent = 'å¯†ç é•¿åº¦è‡³å°‘6ä½';
          errorMsg.style.display = 'block';
          return;
        }

        try {
          const headers = window.authManager ? window.authManager.getAuthHeaders() : {};
          headers['Content-Type'] = 'application/json';
          
          const response = await fetch('/api/users', {
            method: 'POST',
            headers,
            credentials: 'include',
            body: JSON.stringify({
              username,
              email,
              password,
              role,
              permissions: role === 'admin' ? ['read', 'write', 'admin'] : ['read']
            })
          });

          const result = await response.json();
          
          if (result.success) {
            cleanup();
            showMessage('ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
            await loadUserManagement();
          } else {
            errorMsg.textContent = result.error || 'åˆ›å»ºç”¨æˆ·å¤±è´¥';
            errorMsg.style.display = 'block';
          }
        } catch (error) {
          errorMsg.textContent = 'ç½‘ç»œé”™è¯¯: ' + error.message;
          errorMsg.style.display = 'block';
        }
      });

      cancelBtn.addEventListener('click', cleanup);

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          cleanup();
        }
      });

      // èšç„¦åˆ°ç”¨æˆ·åè¾“å…¥æ¡†
      setTimeout(() => dialog.querySelector('#newUsername').focus(), 100);
    }

    // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
    function showMessage(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#bfa940'};
        color: ${type === 'info' ? '#2c2c2c' : 'white'};
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease-out;
      `;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 300);
      }, 3000);
    }

    // å¤„ç†é€€å‡ºç™»å½•
    function handleLogout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        if (window.authManager) {
          window.authManager.logout();
          alert('å·²é€€å‡ºç™»å½•');
          location.href = 'index.html';
        }
      }
    }

    // åŠ è½½è¯„è®ºç®¡ç†åˆ—è¡¨
    async function loadCommentManagement() {
      const container = document.getElementById('commentManagement');
      try {
        const comments = await blogManager.getAllComments();
        if (!comments || comments.length === 0) {
          container.innerHTML = '<div class="empty-state"><i>ğŸ’¬</i><p>æš‚æ— è¯„è®º</p></div>';
          return;
        }
        container.innerHTML = '';
        comments.forEach(comment => {
          const commentElement = document.createElement('div');
          commentElement.className = 'blog-card';
          commentElement.innerHTML = `
            <div class="blog-content" style="display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:1.5rem;">
              <div style="flex:1; min-width:200px;">
                <div class="blog-title" style="margin-bottom:0.5rem;">${comment.author || 'åŒ¿å'}</div>
                <div class="blog-meta">
                  <span class="blog-date">${comment.date || ''}</span>
                  <span class="blog-category">${comment.postTitle ? 'æ–‡ç« : ' + comment.postTitle : ''}</span>
                </div>
                <div class="blog-excerpt" style="margin-top:0.5rem;">${comment.content || ''}</div>
              </div>
              <div class="post-actions" style="display:flex; gap:0.5rem; align-items:center;">
                <button class="blog-btn blog-btn-danger" onclick="deleteComment(${comment.id})">åˆ é™¤</button>
              </div>
            </div>
          `;
          container.appendChild(commentElement);
        });
      } catch (error) {
        console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
        container.innerHTML = '<div class="empty-state"><i>âŒ</i><p>åŠ è½½å¤±è´¥</p></div>';
      }
    }

    // åŠ è½½å›¾ç‰‡ç®¡ç†åˆ—è¡¨ï¼ˆç›´æ¥è¯·æ±‚ /api/imagesï¼Œä¸ image-admin.html ä¸€è‡´ï¼‰
    async function loadImageManagement() {
      const container = document.getElementById('imageManagement');
      container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å›¾ç‰‡...</div>';
      try {
        const headers = window.authManager ? window.authManager.getAuthHeaders() : {};
        const res = await fetch('/api/images', { headers, credentials: 'include' });
        if (!res.ok) throw new Error('è·å–å›¾ç‰‡å¤±è´¥');
        const files = await res.json();
        if (!Array.isArray(files) || files.length === 0) {
          container.innerHTML = '<div class="empty-state"><i>ğŸ–¼ï¸</i><p>æš‚æ— å›¾ç‰‡</p></div>';
          return;
        }
        container.innerHTML = '';
        files.forEach(file => {
          const imgElement = document.createElement('div');
          imgElement.className = 'blog-card';
          imgElement.innerHTML = `
            <div class="blog-content" style="display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:1.5rem;">
              <div style="flex:1; min-width:200px; display:flex; align-items:center; gap:1rem;">
                <img src="/uploads/${file.filename}" alt="å›¾ç‰‡" style="width:60px; height:60px; object-fit:cover; border-radius:5px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                <div>
                  <div class="blog-title" style="margin-bottom:0.5rem;">${file.filename || 'å›¾ç‰‡'}</div>
                  <div class="blog-meta">
                    <span class="blog-date">${file.date || ''}</span>
                    <span class="blog-category">${file.size ? (file.size/1024).toFixed(1) + 'KB' : ''}</span>
                  </div>
                </div>
              </div>
              <div class="post-actions" style="display:flex; gap:0.5rem; align-items:center;">
                <a href="/uploads/${file.filename}" target="_blank" class="blog-btn blog-btn-primary" style="color:#fff;">æŸ¥çœ‹</a>
                <button class="blog-btn blog-btn-danger" onclick="deleteImage('${file.filename}')">åˆ é™¤</button>
              </div>
            </div>
          `;
          container.appendChild(imgElement);
        });
      } catch (error) {
        console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
        container.innerHTML = '<div class="empty-state"><i>âŒ</i><p>åŠ è½½å¤±è´¥</p></div>';
      }
    }

    // åˆ é™¤è¯„è®º
    async function deleteComment(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;
      try {
        if (blogManager.deleteComment) {
          await blogManager.deleteComment(id);
          showMessage('è¯„è®ºåˆ é™¤æˆåŠŸ', 'success');
          await loadCommentManagement();
        } else {
          showMessage('æœªå®ç°è¯„è®ºåˆ é™¤æ¥å£', 'error');
        }
      } catch (error) {
        showMessage('åˆ é™¤è¯„è®ºå¤±è´¥: ' + error.message, 'error');
      }
    }

    // åˆ é™¤å›¾ç‰‡
    async function deleteImage(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;
      try {
        if (blogManager.deleteImage) {
          await blogManager.deleteImage(id);
          showMessage('å›¾ç‰‡åˆ é™¤æˆåŠŸ', 'success');
          await loadImageManagement();
        } else {
          showMessage('æœªå®ç°å›¾ç‰‡åˆ é™¤æ¥å£', 'error');
        }
      } catch (error) {
        showMessage('åˆ é™¤å›¾ç‰‡å¤±è´¥: ' + error.message, 'error');
      }
    }

    // é¡µé¢åˆå§‹åŒ–å’Œä¿®æ”¹å¯†ç åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        if (window.authManager) {
          await window.authManager.waitForInit();
        }
        if (!checkAdminAccess()) return;
        const user = window.authManager.getCurrentUser();
        if (user) {
          document.getElementById('usernameSpan').textContent = `ğŸ‘‹ ${user.username}`;
        }
        await blogManager.loadData();
        await Promise.all([
          loadStats(),
          loadPostManagement(),
          loadCommentManagement(),
          loadImageManagement(),
          loadUserManagement()
        ]);

        // ç»‘å®šä¿®æ”¹å¯†ç è¡¨å•äº‹ä»¶
        const form = document.getElementById('changePwdForm');
        if (form) {
          form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const oldPwd = document.getElementById('oldPwd').value.trim();
            const newPwd = document.getElementById('newPwd').value.trim();
            const confirmPwd = document.getElementById('confirmPwd').value.trim();
            if (!oldPwd || !newPwd || !confirmPwd) {
              showMessage('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
              return;
            }
            if (newPwd !== confirmPwd) {
              showMessage('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
              return;
            }
            try {
              if (!window.authManager || typeof window.authManager.changePassword !== 'function') {
                showMessage('æœªæ‰¾åˆ°å¯†ç ä¿®æ”¹æ¥å£', 'error');
                return;
              }
              const result = await window.authManager.changePassword(oldPwd, newPwd);
              if (!result.success) {
                showMessage('ä¿®æ”¹å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                return;
              }
              showMessage('å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
              form.reset();
            } catch (err) {
              showMessage('è¯·æ±‚å¤±è´¥: ' + err.message, 'error');
            }
          });
        }
      } catch (error) {
        console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
        showMessage('é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
      }
    });

    // æ·»åŠ CSSåŠ¨ç”»
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
