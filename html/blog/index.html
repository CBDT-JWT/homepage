
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åšå®¢ - Weitao Jiang</title>
  <link rel="stylesheet" href="blog.css">
</head>
<body>
  <script src="https://www.unpkg.com/mouse-firework@latest/dist/index.umd.js">

</script>
<script>
    firework({
  excludeElements: ["a"],
  particles: [
    {
      shape: "circle",
      move: "emit",
      easing: "easeOutExpo",
      colors: [
        "rgba(255,182,185,.9)",
        "rgba(250,227,217,.9)",
        "rgba(187,222,214,.9)",
        "rgba(138,198,209,.9)",
      ],
      number: 30,
      duration: [1000,4000],
      shapeOptions: {
        radius: [5, 12],
      },
    },
  ]
});
</script>
  <header class="blog-header">
    <nav class="blog-nav">
      <a href="../index.html" class="blog-logo">Weitao Jiang</a>
      <button class="blog-menu-toggle" aria-label="èœå•">&#9776;</button>
      <ul class="blog-nav-links">
        <li><a href="../index.html">é¦–é¡µ</a></li>
        <li><a href="#" class="active" onclick="location.reload()">åšå®¢</a></li>
        <li><a href="../docs-html/index.html">ç¬”è®°</a></li>
        <li><a href="../about-the-author.html">å…³äº</a></li>
        <li><a href="admin.html" id="adminLink" style="display: none;">ç®¡ç†</a></li>

      </ul>
      <div id="authSection" class="auth-buttons">
        <a href="#" id="loginBtn" onclick="handleLogin()" class="blog-btn blog-btn-primary">ç™»å½•</a>
        <div id="userInfo" class="user-info" style="display: none;">
          <span class="username" id="usernameSpan">ğŸ‘‹ ç”¨æˆ·</span>
          <button class="logout-btn" onclick="handleLogout()">é€€å‡º</button>
        </div>
      </div>
    </nav>

  </header>


  <div class="blog-container">
    <section class="blog-hero">
      <h1>CBDTçš„åšå®¢</h1>
      <p>å¦‚æœæˆ‘åœ¨èµ°ä¸‹å¡è·¯ï¼Œé‚£å°±è¯æ˜æˆ‘çˆ¬è¿‡å±±ğŸ”</p>
    </section>
    <div class="blog-grid" id="blogGrid">
      <!-- åšå®¢æ–‡ç« å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
    </div>
  </div>

  <button class="create-post-btn" id="createPostBtn" onclick="handleCreatePost()" title="å†™æ–°æ–‡ç« " style="display: none;">
    âœï¸
  </button>

  <script src="jwt-auth.js"></script>
  <script src="blog-manager.js"></script>
  <script>
    // æ±‰å ¡èœå•å±•å¼€/æ”¶èµ·+è‡ªé€‚åº”
    document.addEventListener('DOMContentLoaded', function() {
      var toggle = document.querySelector('.blog-menu-toggle');
      var navLinks = document.querySelector('.blog-nav-links');
      function handleResize() {
        if (window.innerWidth > 768 && navLinks) {
          navLinks.classList.remove('open');
        }
      }
      if (toggle && navLinks) {
        toggle.addEventListener('click', function() {
          navLinks.classList.toggle('open');
        });
        window.addEventListener('resize', handleResize);
        handleResize(); // åˆå§‹æ‰§è¡Œä¸€æ¬¡
      }
    });
  </script>
  <script>
    // æ¸²æŸ“åšå®¢æ–‡ç« 
    async function renderBlogPosts() {
      const blogGrid = document.getElementById('blogGrid');
      blogGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: white;">æ­£åœ¨åŠ è½½æ–‡ç« ...</div>';

      try {
        // ä»BlogManagerè·å–æ–‡ç« æ•°æ®
        const blogPosts = await blogManager.getAllPosts();

        blogGrid.innerHTML = '';

        if (blogPosts.length === 0) {
          blogGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: white;">æš‚æ— æ–‡ç« ï¼Œ<a href="write-post.html" style="color: #FFD700;">ç‚¹å‡»è¿™é‡Œ</a> å¼€å§‹åˆ›ä½œç¬¬ä¸€ç¯‡æ–‡ç« ï¼</div>';
          return;
        }

        // æŒ‰æ—¥æœŸå’ŒIDæ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
        blogPosts.sort((a, b) => {
          // é¦–å…ˆæŒ‰æ—¥æœŸæ’åºï¼ˆå¦‚æœæœ‰æ—¥æœŸçš„è¯ï¼‰
          if (a.date && b.date) {
            const dateA = new Date(a.date);
            const dateB = new Date(b.date);
            if (dateA.getTime() !== dateB.getTime()) {
              return dateB.getTime() - dateA.getTime(); // é™åºï¼Œæœ€æ–°çš„åœ¨å‰
            }
          }
          // å¦‚æœæ—¥æœŸç›¸åŒæˆ–æ²¡æœ‰æ—¥æœŸï¼ŒæŒ‰IDæ’åºï¼ˆIDè¶Šå¤§è¶Šæ–°ï¼‰
          return (b.id || 0) - (a.id || 0);
        });

        blogPosts.forEach(post => {
          const blogCard = document.createElement('div');
          blogCard.className = 'blog-card';
          blogCard.onclick = () => viewPost(post.id);

          // å…¼å®¹æ–°æ—§å°é¢å­—æ®µï¼Œä¼˜å…ˆ cover.value
          let imageHTML = '';
          let img = '';
          if (post.cover && post.cover.value) {
            img = String(post.cover.value).trim();
          } else if (post.image) {
            img = String(post.image).trim();
          }
          // emoji æ­£åˆ™ï¼ˆæ”¯æŒå•ä¸ªæˆ–å¤šä¸ª emojiï¼‰
          const emojiRegex = /^[\p{Emoji}\u200d\s]+$/u;
          if (img && emojiRegex.test(img)) {
            imageHTML = `<div class="blog-image-default" style="font-size:3.5rem;">${img}</div>`;
          } else if (img && (/^(\/|https?:\/\/).+/i.test(img) || /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(img))) {
            imageHTML = `<img src="${img}" alt="å°é¢" class="blog-image-img" loading="lazy" onerror="this.style.display='none';this.insertAdjacentHTML('afterend','<div class=\'blog-image-default\'>ğŸ“</div>');" />`;
          } else {
            imageHTML = '<div class="blog-image-default">ğŸ“</div>';
          }

          blogCard.innerHTML = `
            <div class="blog-image">${imageHTML}</div>
            <div class="blog-content">
              <div class="blog-meta">
                <span class="blog-category">${post.category}</span>
                <span class="blog-date">${post.date}</span>
                ${post.views ? `<span class="blog-views">ğŸ‘ï¸ ${post.views}</span>` : ''}
              </div>
              <h3 class="blog-title">${post.title}</h3>
              <p class="blog-excerpt">${post.excerpt}</p>
              <a href="#" class="read-more" onclick="event.stopPropagation(); viewPost(${post.id})">é˜…è¯»æ›´å¤š â†’</a>
            </div>
          `;

          blogGrid.appendChild(blogCard);
        });
      } catch (error) {
        console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
        blogGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: white;">âŒ åŠ è½½æ–‡ç« å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
      }
    }

    // æŸ¥çœ‹æ–‡ç« è¯¦æƒ…
    function viewPost(id) {
      // ä½¿ç”¨URLå‚æ•°ä¼ é€’æ–‡ç« ID
      location.href = `post.html?id=${id}`;
    }

    // é¡µé¢åŠ è½½æ—¶æ¸²æŸ“æ–‡ç« 
    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // ç¡®ä¿è®¤è¯ç®¡ç†å™¨åˆå§‹åŒ–
        if (window.authManager) {
          await window.authManager.waitForInit();
        }
        
        // ç¡®ä¿BlogManageråˆå§‹åŒ–ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ®
        blogManager.isLoaded = false;
        await blogManager.loadData();
        
        // æ¸²æŸ“æ–‡ç« 
        await renderBlogPosts();
        
        // æ›´æ–°UIæƒé™çŠ¶æ€
        updateUIBasedOnAuth();
      } catch (error) {
        console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
        const blogGrid = document.getElementById('blogGrid');
        blogGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: white;">âŒ é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
      }
        });
    // æ›´æ–°UIåŸºäºè®¤è¯çŠ¶æ€
    function updateUIBasedOnAuth() {
      const adminLink = document.getElementById('adminLink');
      const createPostBtn = document.getElementById('createPostBtn');
      const loginBtn = document.getElementById('loginBtn');
      const userInfo = document.getElementById('userInfo');
      const usernameSpan = document.getElementById('usernameSpan');
      
      if (window.authManager && window.authManager.isLoggedIn()) {
        // ç”¨æˆ·å·²ç™»å½•
        if (loginBtn) loginBtn.style.display = 'none';
        if (userInfo) userInfo.style.display = 'flex';
        if (createPostBtn) createPostBtn.style.display = 'block';
        
        const user = window.authManager.getCurrentUser();
        if (user && usernameSpan) {
          usernameSpan.textContent = `ğŸ‘‹ ${user.username}`;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
        if (window.authManager.isAdmin()) {
          if (adminLink) adminLink.style.display = 'block';
        } else {
          if (adminLink) adminLink.style.display = 'none';
        }
      } else {
        // ç”¨æˆ·æœªç™»å½•
        if (loginBtn) loginBtn.style.display = 'inline-flex';
        if (userInfo) userInfo.style.display = 'none';
        if (createPostBtn) createPostBtn.style.display = 'none';
        if (adminLink) adminLink.style.display = 'none';
      }
    }

    // å¤„ç†åˆ›å»ºæ–‡ç« 
    function handleCreatePost() {
      if (window.authManager && window.authManager.isLoggedIn()) {
        location.href = 'write-post.html';
      } else {
        alert('è¯·å…ˆç™»å½•åå†å†™æ–‡ç« ');
        handleLogin();
      }
    }

    // å¤„ç†ç™»å½•
    async function handleLogin() {
      try {
        if (!window.authManager) {
          alert('è®¤è¯ç³»ç»ŸæœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
          return;
        }
        
        const success = await window.authManager.showLoginDialog();
        if (success) {
          updateUIBasedOnAuth();
          alert('ç™»å½•æˆåŠŸï¼');
        }
      } catch (error) {
        console.error('ç™»å½•å¤±è´¥:', error);
        alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // å¤„ç†é€€å‡º
    function handleLogout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        if (window.authManager) {
          window.authManager.logout();
          updateUIBasedOnAuth();
          alert('å·²é€€å‡ºç™»å½•');
        }
      }
    }
  </script>
</body>
</html>
