<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¯„è®ºç®¡ç† - Weitao Jiang</title>
  <link rel="stylesheet" href="blog.css">
  <style>
    /* è¯„è®ºç®¡ç†é¡µé¢ç‰¹æœ‰æ ·å¼ */
    .comment-admin-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2rem;
    }

    .comment-section {
      background: #232526;
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .comment-section h3 {
      margin-bottom: 1.5rem;
      color: #bfa940;
      border-bottom: 2px solid #bfa940;
      padding-bottom: 0.5rem;
    }

    .comment-item {
      padding: 1.5rem;
      background: #232526;
      border-radius: 3px;
      margin-bottom: 1rem;
      border-left: 4px solid #bfa940;
      color: #fff;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .comment-info {
      flex: 1;
    }

    .comment-author {
      font-weight: 600;
      color: #fff;
      margin-bottom: 0.3rem;
    }

    .comment-meta {
      font-size: 0.9rem;
      color: #fff;
    }

    .comment-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .comment-content {
      color: #fff;
      line-height: 1.6;
      margin-bottom: 1rem;
      padding: 1rem;
      background: #181818;
      border-radius: 2px;
      border: 1px solid #444;
    }

    .comment-post-link {
      font-size: 0.9rem;
      color: #bfa940;
      text-decoration: none;
      font-weight: 500;
    }

    .comment-post-link:hover {
      text-decoration: underline;
    }

    .btn-small {
      padding: 0.3rem 0.8rem;
      font-size: 0.8rem;
      border-radius: 5px;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #bfa940;
      color: #232526;
      padding: 1.5rem;
      border-radius: var(--border-radius);
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .filter-section {
      background: #232526;
      padding: 1rem;
      border-radius: 3px;
      margin-bottom: 1.5rem;
    }

    .filter-row {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 2px;
      background: #181818;
      color: #fff;
    }

    .no-comments {
      text-align: center;
      color: #fff;
      font-style: italic;
      padding: 3rem;
    }

    @media (max-width: 768px) {
      .comment-admin-container {
        padding: 1rem;
      }
      
      .comment-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .comment-actions {
        width: 100%;
        justify-content: flex-end;
      }
      
      .filter-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .stats-summary {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="blog-header">
    <nav class="blog-nav">
      <a href="../index.html" class="blog-logo">Weitao Jiang</a>
      <ul class="blog-nav-links">
        <li><a href="../index.html">é¦–é¡µ</a></li>
        <li><a href="index.html">åšå®¢</a></li>
        <li><a href="../docs-html/index.html">ç¬”è®°</a></li>
        <li><a href="../about-the-author.html">å…³äº</a></li>
        <li><a href="admin.html" id="adminLink" style="display: none;">ç®¡ç†</a></li>
        <li><a href="#" class="active" id="commentAdminLink">è¯„è®ºç®¡ç†</a></li>
        <li><a href="image-admin.html" id="imageAdminLink" style="display: none;">å›¾ç‰‡ç®¡ç†</a></li>
      </ul>
      <div id="authSection" class="auth-buttons">
        <div id="userInfo" class="user-info">
          <span class="username" id="usernameSpan">ğŸ‘‹ ç®¡ç†å‘˜</span>
          <button class="logout-btn" onclick="handleLogout()">é€€å‡º</button>
        </div>
      </div>
    </nav>
  </header>

  <div class="comment-admin-container">
    <div class="blog-hero">
      <h1>ğŸ’¬ è¯„è®ºç®¡ç†</h1>
      <p>ç®¡ç†æ‰€æœ‰æ–‡ç« çš„è¯„è®ºå’Œäº’åŠ¨</p>
    </div>

    <div class="stats-summary">
      <div class="stat-card">
        <div class="stat-number" id="totalComments">0</div>
        <div class="stat-label">æ€»è¯„è®ºæ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="todayComments">0</div>
        <div class="stat-label">ä»Šæ—¥è¯„è®º</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="recentComments">0</div>
        <div class="stat-label">è¿‘7å¤©è¯„è®º</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="postsWithComments">0</div>
        <div class="stat-label">æœ‰è¯„è®ºçš„æ–‡ç« </div>
      </div>
    </div>

    <div class="comment-section">
      <h3>ğŸ“ è¯„è®ºåˆ—è¡¨</h3>
      
      <div class="filter-section">
        <div class="filter-row">
          <label>ç­›é€‰æ¡ä»¶ï¼š</label>
          <select id="postFilter" class="filter-select" onchange="filterComments()">
            <option value="">æ‰€æœ‰æ–‡ç« </option>
            <!-- æ–‡ç« é€‰é¡¹å°†åŠ¨æ€åŠ è½½ -->
          </select>
          <select id="dateFilter" class="filter-select" onchange="filterComments()">
            <option value="">æ‰€æœ‰æ—¶é—´</option>
            <option value="today">ä»Šå¤©</option>
            <option value="week">æœ¬å‘¨</option>
            <option value="month">æœ¬æœˆ</option>
          </select>
          <button class="blog-btn blog-btn-secondary" onclick="refreshComments()">åˆ·æ–°</button>
        </div>
      </div>

      <div id="commentsList">
        <!-- è¯„è®ºåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
      </div>
    </div>
  </div>

  <script src="jwt-auth.js"></script>
  <script src="blog-manager.js"></script>
  <script>
    let allComments = [];
    let allPosts = [];
    let filteredComments = [];

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // æ£€æŸ¥æƒé™
        if (!window.authManager || !window.authManager.isLoggedIn() || !window.authManager.isAdmin()) {
          alert('æ‚¨æ²¡æœ‰è®¿é—®è¯„è®ºç®¡ç†çš„æƒé™');
          location.href = 'index.html';
          return;
        }
        // æ˜¾ç¤ºç®¡ç†èœå•
        document.getElementById('adminLink').style.display = '';
        document.getElementById('commentAdminLink').style.display = '';
        document.getElementById('imageAdminLink').style.display = '';
        // ç¡®ä¿BlogManageråˆå§‹åŒ–
        await blogManager.loadData();
        // åŠ è½½æ•°æ®
        await loadCommentData();
        // æ›´æ–°UI
        updateUIBasedOnAuth();
      } catch (error) {
        console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
        alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
      }
    });

    // åŠ è½½è¯„è®ºæ•°æ®
    async function loadCommentData() {
      try {
        // è·å–æ‰€æœ‰è¯„è®ºå’Œæ–‡ç« 
        allComments = await blogManager.getAllComments();
        allPosts = await blogManager.getAllPosts();
        filteredComments = [...allComments];
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        updateStats();
        
        // åŠ è½½æ–‡ç« ç­›é€‰é€‰é¡¹
        loadPostFilter();
        
        // æ˜¾ç¤ºè¯„è®ºåˆ—è¡¨
        displayComments();
      } catch (error) {
        console.error('åŠ è½½è¯„è®ºæ•°æ®å¤±è´¥:', error);
      }
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    function updateStats() {
      const today = new Date().toLocaleDateString('zh-CN');
      const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toLocaleDateString('zh-CN');
      
      const todayComments = allComments.filter(comment => comment.date === today);
      const recentComments = allComments.filter(comment => {
        const commentDate = new Date(comment.date);
        const weekAgoDate = new Date(weekAgo);
        return commentDate >= weekAgoDate;
      });
      
      const postsWithComments = new Set(allComments.map(comment => comment.postId)).size;
      
      document.getElementById('totalComments').textContent = allComments.length;
      document.getElementById('todayComments').textContent = todayComments.length;
      document.getElementById('recentComments').textContent = recentComments.length;
      document.getElementById('postsWithComments').textContent = postsWithComments;
    }

    // åŠ è½½æ–‡ç« ç­›é€‰é€‰é¡¹
    function loadPostFilter() {
      const postFilter = document.getElementById('postFilter');
      const defaultOption = postFilter.querySelector('option[value=""]');
      
      // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™é»˜è®¤é€‰é¡¹
      postFilter.innerHTML = '';
      postFilter.appendChild(defaultOption);
      
      // æ·»åŠ æ–‡ç« é€‰é¡¹
      allPosts.forEach(post => {
        const option = document.createElement('option');
        option.value = post.id;
        option.textContent = post.title;
        postFilter.appendChild(option);
      });
    }

    // ç­›é€‰è¯„è®º
    function filterComments() {
      const postFilter = document.getElementById('postFilter').value;
      const dateFilter = document.getElementById('dateFilter').value;
      
      filteredComments = allComments.filter(comment => {
        let matchPost = true;
        let matchDate = true;
        
        // æŒ‰æ–‡ç« ç­›é€‰
        if (postFilter) {
          matchPost = comment.postId == postFilter;
        }
        
        // æŒ‰æ—¥æœŸç­›é€‰
        if (dateFilter) {
          const commentDate = new Date(comment.date);
          const today = new Date();
          
          switch (dateFilter) {
            case 'today':
              matchDate = comment.date === today.toLocaleDateString('zh-CN');
              break;
            case 'week':
              const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
              matchDate = commentDate >= weekAgo;
              break;
            case 'month':
              const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
              matchDate = commentDate >= monthAgo;
              break;
          }
        }
        
        return matchPost && matchDate;
      });
      
      displayComments();
    }

    // æ˜¾ç¤ºè¯„è®ºåˆ—è¡¨
    function displayComments() {
      const commentsList = document.getElementById('commentsList');
      
      if (filteredComments.length === 0) {
        commentsList.innerHTML = '<div class="no-comments">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è¯„è®º</div>';
        return;
      }
      
      // æŒ‰æ—¥æœŸå€’åºæ’åº
      const sortedComments = filteredComments.sort((a, b) => {
        return new Date(b.date) - new Date(a.date);
      });
      
      commentsList.innerHTML = sortedComments.map(comment => {
        const post = allPosts.find(p => p.id == comment.postId);
        const postTitle = post ? post.title : 'æœªçŸ¥æ–‡ç« ';
        
        return `
          <div class="comment-item">
            <div class="comment-header">
              <div class="comment-info">
                <div class="comment-author">${comment.author}</div>
                <div class="comment-meta">
                  è¯„è®ºæ—¶é—´ï¼š${comment.date}
                  ${comment.email ? ` | é‚®ç®±ï¼š${comment.email}` : ''}
                </div>
              </div>
              <div class="comment-actions">
                <button class="blog-btn btn-small btn-danger" onclick="deleteComment(${comment.id}, '${comment.author}')">åˆ é™¤</button>
              </div>
            </div>
            <div class="comment-content">${comment.content}</div>
            <a href="post.html?id=${comment.postId}" class="comment-post-link" target="_blank">
              æ–‡ç« ï¼š${postTitle} â†’
            </a>
          </div>
        `;
      }).join('');
    }

    // åˆ é™¤è¯„è®º
    async function deleteComment(commentId, author) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤æ¥è‡ª"${author}"çš„è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }
      
      try {
        await blogManager.deleteComment(commentId);
        alert('è¯„è®ºåˆ é™¤æˆåŠŸ');
        await refreshComments(); // é‡æ–°åŠ è½½æ•°æ®
      } catch (error) {
        console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
        alert('åˆ é™¤è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // åˆ·æ–°è¯„è®ºæ•°æ®
    async function refreshComments() {
      try {
        await loadCommentData();
        alert('è¯„è®ºæ•°æ®å·²åˆ·æ–°');
      } catch (error) {
        console.error('åˆ·æ–°è¯„è®ºæ•°æ®å¤±è´¥:', error);
        alert('åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // æ›´æ–°UIåŸºäºè®¤è¯çŠ¶æ€
    function updateUIBasedOnAuth() {
      const userInfo = document.getElementById('userInfo');
      const usernameSpan = document.getElementById('usernameSpan');
      
      if (window.authManager && window.authManager.isLoggedIn()) {
        const user = window.authManager.getCurrentUser();
        if (user && usernameSpan) {
          usernameSpan.textContent = `ğŸ‘‹ ${user.username}`;
        }
      }
    }

    // å¤„ç†é€€å‡º
    function handleLogout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        if (window.authManager) {
          window.authManager.logout();
          alert('å·²é€€å‡ºç™»å½•');
          location.href = 'index.html';
        }
      }
    }
  </script>
</body>
</html>
